<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SXC CSV Header Converter</title>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #f2f4f8;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
  }

  .container {
    width: 100%;
    max-width: 700px;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
  }

  h2 {
    margin-top: 0;
    color: #2c3e50;
  }

  .upload-area {
    border: 2px dashed #3498db;
    padding: 40px;
    border-radius: 10px;
    background: #f9fbfd;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 120px;
  }

  select {
    width: 100%;
    padding: 10px;
    margin-top: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  button {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
  }

  .status {
    margin-top: 15px;
    padding: 10px;
    border-radius: 6px;
    display: none;
  }

  .success {
    background: #e8f8f0;
    color: #1e8449;
  }

  .error {
    background: #fdecea;
    color: #c0392b;
  }

  footer {
    margin-top: 20px;
    color: #555;
    font-size: 13px;
  }

  input[type="file"] {
    display: none;
  }
</style>
</head>

<body>

<div class="container">
  <h2>SFM1x-C cloud to CIS DataView Convert</h2>

  <label class="upload-area" id="dropZone">
    Click or Drag CSV File Here
    <input type="file" id="fileInput" accept=".csv">
  </label>

  <select id="timezone">
    <option value="UTC">UTC (Original)</option>

    <option value="Australia/Sydney">Australia - Sydney</option>
    <option value="Australia/Melbourne">Australia - Melbourne</option>
    <option value="Australia/Brisbane">Australia - Brisbane</option>
    <option value="Australia/Perth">Australia - Perth</option>
    <option value="Australia/Adelaide">Australia - Adelaide</option>

    <option value="Asia/Kathmandu">Nepal - Kathmandu</option>
    <option value="Asia/Kolkata">India - Kolkata</option>
    <option value="Asia/Tokyo">Japan - Tokyo</option>

    <option value="Europe/London">UK - London</option>

    <option value="America/New_York">USA - New York</option>
    <option value="America/Los_Angeles">USA - Los Angeles</option>
  </select>

  <button onclick="processCSV()">Convert & Download</button>

  <div id="status" class="status"></div>

  <footer>
    Developed by ICT International
  </footer>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener("click", () => fileInput.click());

function convertUTCToZone(dateStr, timeStr, zone) {
    let utcDate = new Date(dateStr + "T" + timeStr + "Z");

    let options = {
        timeZone: zone,
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    };

    let formatted = new Intl.DateTimeFormat('en-GB', options).format(utcDate);

    let parts = formatted.split(", ");

    let date = parts[0];
    let time = parts[1];

    return { date, time };
}

function showStatus(message, type) {
  const statusBox = document.getElementById('status');
  statusBox.style.display = "block";
  statusBox.className = "status " + type;
  statusBox.innerHTML = message;
}

function processCSV() {
    const file = fileInput.files[0];

    if (!file) {
        showStatus("Please upload a CSV file first", "error");
        return;
    }

    const zone = document.getElementById("timezone").value;

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const lines = e.target.result.trim().split("\n");

            const firstRow = lines[0].split(",");
            const serial = firstRow[1];

            let output = [];

            output.push(`Serial Number:,${serial}` + ",".repeat(13));

            output.push(
              "Date ,Time ,Uncorrected Out (cm/hr),Uncorrected In (cm/hr)," +
              "Corrected Out (cm/hr),Corrected In (cm/hr)," +
              "Sap Flow Out (kg/hr),Sap Flow In (kg/hr)," +
              "Internal Battery Voltage (V),Battery Charge Current (mA)," +
              "Internal Battery Temperature (Â°C)," +
              "External Power Supply Present," +
              "External Power Supply Voltage (V)," +
              "External Power Supply Current (mA)"
            );

            for (let i = 0; i < lines.length; i++) {
                const cols = lines[i].split(",");

                const datetime = cols[0].split(" ");
                const dateUTC = datetime[0];
                const timeUTC = datetime[1];

                let converted = convertUTCToZone(dateUTC, timeUTC, zone);

                const data = [
                    converted.date,
                    converted.time,
                    ...cols.slice(2, 14)
                ];

                output.push(data.join(","));
            }

            downloadCSV(output.join("\n"), serial + "_" + zone.replace("/","_") + ".csv");

            showStatus("File converted to " + zone + " time successfully!", "success");

        } catch (err) {
            showStatus("Error processing file. Please check CSV format.", "error");
        }
    };

    reader.readAsText(file);
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}
</script>

</body>
</html>
